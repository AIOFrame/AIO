(function(a){a.fn.tagComplete=function(d){var b={hide:false,keyLimit:1,tokenizer:",",freeInput:true,freeEdit:true,autocomplete:{data:[],ajaxOpts:{method:"GET",dataType:"json",data:{}},params:function(e){return{q:e,lol:23}},proccessData:function(e){return e}},onAdd:function(e){return true},onDelete:function(e){return true}};var c=a.extend(true,b,d);backspaceKey=8;enterKey=13;this.destroy=function(){var e=a(this).data("tagcomplete-id");if(!e){return false}var f=document.getElementById(e);a(f).remove();a(this).removeData();a(this).val("");refreshDom=new Date().getTime()+Math.random();a(this).attr("data-tagcomplete-refresh",refreshDom);a(this).addClass("tag-complete-dead").removeClass("hide")};this.reInit=function(e){this.destroy();if(e){c=a.extend(true,c,e)}return a.fn.tagComplete.call(this,c)};return this.each(function(h,g){var f=this;ajaxPool=[];userInput=f=a(g);var e=userInput.val()||"";userInput.hide();h=h+1;j="";var j=h+(new Date()).getTime()+Math.floor(Math.random());tagCompleteMain=a("<div id='"+j+"' class='tag_complete_main'><div class='tag_complete'><div class='tags_container'></div><input type='text' class='tag_input' /></div><ul class='autocomplete hide'></ul></div>");if(c.hide==true){tagCompleteMain.hide()}userInput.attr("data-tagcomplete-id",j);tagCompleteMain.insertAfter(userInput);tagComplete=tagCompleteMain.find(".tag_complete");tagInput=tagComplete.find(".tag_input");tagsContainer=tagComplete.find(".tags_container");autoComplete=tagCompleteMain.find(".autocomplete");instanceData={userInput:userInput,tagCompleteMain:tagCompleteMain,tagComplete:tagComplete,tagsContainer:tagsContainer,tagInput:tagInput,autoComplete:autoComplete,options:c,ajaxPool:ajaxPool};this.instance=f.instance=instanceData;if(e.length>0){var k=e.split(c.tokenizer);a.each(k,function(l,m){a.fn.addTag(m,m,f.instance)})}tagComplete.on("click",instanceData,function(l){l.data.tagInput.focus()});tagInput.on("focus",instanceData,function(l){l.data.tagComplete.addClass("is_focused")}).on("blur",instanceData,function(l){l.data.tagComplete.removeClass("is_focused")});autoComplete.on("click","li",instanceData,function(l){inst=l.data;var m=a(this).data("id");a.fn.addTag(m,a(this).text(),inst);a.fn.refreshUserInput(inst.userInput,inst.tagsContainer,inst.options);tagInput.val("");a.fn.abortAjax(ajaxPool);a.fn.clearAutoComplete(inst.autoComplete)});tagsContainer.on("click",".tag .close",instanceData,function(l){inst=l.data;tag=a(this).parent(".tag");a.fn.deleteTag(tag,inst)});tagInput.on("keyup",instanceData,function(l){instance=l.data;tagCompleteMain=instance.tagCompleteMain;tagComplete=instance.tagComplete;tagsContainer=instance.tagsContainer;f=tagInput=instance.tagInput;autoComplete=instance.autoComplete;c=instance.options;ajaxPool=instance.ajaxPool;value=a(this).val();keycode=(l.keyCode?l.keyCode:l.which);if(value.length==0){a.fn.clearAutoComplete(autoComplete)}if(c.freeEdit&&(value.length==0&&keycode==backspaceKey)){lastTagNo=tagsContainer.find(".tag").length;if(lastTagNo==0){return false}lastTagInfo=a.fn.getTagInfo(tagsContainer,lastTagNo);a.fn.deleteTag(lastTagInfo.selector,instance);if((c.freeEdit&&c.freeInput)==true){tagInput.focus().val(lastTagInfo.text)}return f}else{if((keycode==enterKey||l.key==c.tokenizer)&&value.length>0&&c.freeInput==true){if(value.endsWith(c.tokenizer)){value=value.slice(0,value.lastIndexOf(c.tokenizer))}value=a.trim(value);if(value.length==0){a(this).val("");return f}a.fn.addTag(value,value,instance);a(this).val("");return f}}autoCompeleteData=c.autocomplete.data;matchedData={};if(c.freeInput==true){matchedData[value]=value}if(value.length<c.keyLimit){return f}if(typeof c.autocomplete.data=="object"){for(i=0;i<autoCompeleteData.length;i++){dataWord=autoCompeleteData[i];if(dataWord.indexOf(value)==-1){continue}matchedData[dataWord]=dataWord}a.fn.updateAutoComplete(autoComplete,matchedData)}dataUrl=c.autocomplete.ajaxOpts.url;if(dataUrl!=null){ajaxOpts=c.autocomplete.ajaxOpts;params=c.autocomplete.params.call(null,value);ajaxOpts.data=a.extend(c.data,params);ajaxReq=a.ajax(ajaxOpts).done(function(m){proccessedData=c.autocomplete.proccessData.call(null,m);if(proccessedData.length==0){return false}a.extend(matchedData,proccessedData);a.fn.updateAutoComplete(autoComplete,matchedData)})}})})};a.fn.addTag=function(c,d,b){closeTag="<span class='close'></span>";tag=a("<span data-id='"+c+"' class='tag'>"+d+closeTag+"</span>");if(b.options.onAdd.call(null,{tagId:c,tagText:d})){b.tagsContainer.append(tag)}a.fn.abortAjax(b.ajaxPool);a.fn.clearAutoComplete(b.autoComplete);a.fn.refreshUserInput(b.userInput,b.tagsContainer,b.options);return true};a.fn.getTagInfo=function(b,c){selector=".tag:nth-child("+c+")";tagDom=b.find(selector);tagText=tagDom.text();tagId=tagDom.data("id");tagInfo={id:tagId,text:tagText,selector:tagDom};return tagInfo};a.fn.updateAutoComplete=function(d,c){var b="";a.each(c,function(f,e){b+="<li data-id='"+f+"'>"+e+"</li>"});d.empty().html(b).removeClass("hide");d.parent(".tag_complete_main").find(".tag_complete").addClass("has_autocomplete")};a.fn.clearAutoComplete=function(b){b.addClass("hide").empty();b.parent(".tag_complete_main").find(".tag_complete").removeClass("has_autocomplete")};a.fn.abortAjax=function(b){if(b.length>0){a.each(b,function(d,c){c.abort()})}};a.fn.refreshUserInput=function(d,b,c){tokenizer=c.tokenizer;tokenizedData="";tags=b.find(".tag");if(tags.length==0){return false}a.each(tags,function(e,f){tagData=a(this).data("id")||a(this).text();tokenizedData+=tagData+","});tokenizedData=tokenizedData.slice(0,tokenizedData.lastIndexOf(","));d.val(tokenizedData)};a.fn.deleteTag=function(c,b){var d=a(c).data("id");var e=a(c).text();c.remove();b.options.onDelete.call(null,{id:d,text:e});a.fn.refreshUserInput(b.userInput,b.tagsContainer,b.options);return true}}(jQuery));